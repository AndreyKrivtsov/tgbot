# üìã –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –ø—Ä–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø–∞ –∏ –ª–∏–º–∏—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã.

**–í–µ—Ä—Å–∏—è –±–æ—Ç–∞**: 2.0.0-modular (`BOT_CONFIG.VERSION`)

## üîê –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### –£—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞

1. **–°—É–ø–µ—Ä–∞–¥–º–∏–Ω** (`ADMIN_USERNAME`)
   - –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI –≤ –ª—é–±—ã—Ö —á–∞—Ç–∞—Ö
   - –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ `/ultron @chat_username [1/0]`

2. **–ê–¥–º–∏–Ω—ã –≥—Ä—É–ø–ø** (–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –ë–î)
   - –ö–æ–º–∞–Ω–¥—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –≤ —Å–≤–æ–∏—Ö –≥—Ä—É–ø–ø–∞—Ö
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI –≤ —Å–≤–æ–∏—Ö —á–∞—Ç–∞—Ö
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥—Ä—É–ø–ø

3. **–û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**
   - –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (`/start`, `/help`)
   - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å AI (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞
private isSuperAdmin(username?: string): boolean {
  return username === this.config.ADMIN_USERNAME?.replace("@", "")
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞ –≥—Ä—É–ø–ø—ã
private async isGroupAdmin(context: TelegramMessageContext): Promise<boolean> {
  return await this.chatRepository.isAdmin(chatId, userId)
}
```

## üè¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –ø–æ —Ç–∏–ø—É —á–∞—Ç–∞

### –ö–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø
–°–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç **—Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö** (`chatId < 0`):

- `/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥—Ä—É–ø–ø—ã
- `/unregister` - –æ—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `/ultron [1/0]` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI
- `/ban @user` - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/unban @user` - —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- `/mute @user` - –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- `/unmute @user` - –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

**–û—à–∏–±–∫–∞ –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ:**
```
üè¢ –ö–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≥—Ä—É–ø–ø
```

### –ö–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞

- `/addAltronKey @group API_KEY` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞

**–û—à–∏–±–∫–∞ –≤ –≥—Ä—É–ø–ø–µ:**
```
üîê –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ
```

## ü§ñ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è AI —Å–µ—Ä–≤–∏—Å–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ |
|----------|----------|-----------|
| –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ | 10 —Å–æ–æ–±—â–µ–Ω–∏–π | `MAX_QUEUE_SIZE` |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞ | 500 —Å–æ–æ–±—â–µ–Ω–∏–π | `MAX_CONTEXT_MESSAGES` |
| –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ | 4000 —Å–∏–º–≤–æ–ª–æ–≤ | `MAX_RESPONSE_LENGTH` |
| –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ | 5 —Å–µ–∫—É–Ω–¥ | `AI_REQUEST_TIMEOUT_MS` |
| TTL –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | 24 —á–∞—Å–∞ | `CONTEXT_TTL_SECONDS` |

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞

1. **AI –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–∞—Ö**
   ```typescript
   // –ï—Å–ª–∏ —á–∞—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π ‚Äî –±–æ—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å
   if (chat?.type === "private") {
     return null
   }
   ```

2. **–û–±—è–∑–∞—Ç–µ–ª–µ–Ω API –∫–ª—é—á**
   ```
   –û—à–∏–±–∫–∞: "API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω"
   ```

3. **AI –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω –≤ —á–∞—Ç–µ**
   ```
   –û—à–∏–±–∫–∞: "AI –æ—Ç–∫–ª—é—á–µ–Ω –≤ —ç—Ç–æ–º —á–∞—Ç–µ"
   ```

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```typescript
validateMessage(message: string): ValidationResult {
  // –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  if (!message || message.trim().length === 0) {
    return { isValid: false, reason: "–°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ" }
  }

  // –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
  if (message.length > 4000) {
    return { isValid: false, reason: "–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ" }
  }

  // –°–ø–∞–º (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã)
  if (this.isSpamMessage(message)) {
    return { isValid: false, reason: "–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å–ø–∞–º" }
  }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏

```typescript
if (queueLength >= AI_CHAT_CONFIG.MAX_QUEUE_SIZE) {
  return {
    success: false,
    queued: false,
    reason: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥–∏"
  }
}
```

## ‚ö° –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–∞

### Token Bucket –∞–ª–≥–æ—Ä–∏—Ç–º

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| Capacity | 6 —Ç–æ–∫–µ–Ω–æ–≤ | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
| Tokens per request | 1 —Ç–æ–∫–µ–Ω | –¢–æ–∫–µ–Ω–æ–≤ –∑–∞ –∑–∞–ø—Ä–æ—Å |
| Refill rate | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π | –ù–∞ –æ—Å–Ω–æ–≤–µ MAX_DELAY |

### –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ –¥–ª–∏–Ω–µ –æ—Ç–≤–µ—Ç–∞

```typescript
private calculateAdaptiveDelay(responseLength: number): number {
  const { MAX_DELAY, SHORT_RESPONSE_THRESHOLD, LONG_RESPONSE_THRESHOLD } = AI_THROTTLE_CONFIG

  if (responseLength <= 100) return 0           // –ö–æ—Ä–æ—Ç–∫–∏–µ - –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
  if (responseLength >= 500) return 20000       // –î–ª–∏–Ω–Ω—ã–µ - 20 —Å–µ–∫

  // –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É –ø–æ—Ä–æ–≥–∞–º–∏
  const ratio = (responseLength - 100) / (500 - 100)
  return Math.round(20000 * ratio)
}
```

### Cleanup –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤

- **–ò–Ω—Ç–µ—Ä–≤–∞–ª**: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (`CLEANUP_INTERVAL`)
- **–¢–∞–π–º–∞—É—Ç**: 30 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (`INACTIVE_TIMEOUT`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ø–∞–º—è—Ç–∏

### –î—Ä—É–≥–∏–µ cleanup –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

| –°–µ—Ä–≤–∏—Å | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|-----------|----------|
| UserManager | 30 –º–∏–Ω—É—Ç | `cleanupIntervalMs` | –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| ContextManager | –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é | - | –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –¥–∏–∞–ª–æ–≥–æ–≤ |
| TokenBucket | 5 –º–∏–Ω—É—Ç | `CLEANUP_INTERVAL` | –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö bucket'–æ–≤ |

## üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –∫–∞–ø—á–∏

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–ø—á–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ |
|----------|----------|-----------|
| –¢–∞–π–º–∞—É—Ç —Ä–µ—à–µ–Ω–∏—è | 60 —Å–µ–∫—É–Ω–¥ | `CAPTCHA_TIMEOUT_MS` |
| –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ | 5 —Å–µ–∫—É–Ω–¥ | `CAPTCHA_CHECK_INTERVAL_MS` |
| –í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞–Ω | 40 —Å–µ–∫—É–Ω–¥ | `TEMPORARY_BAN_DURATION_SEC` |
| –ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–±–∞–Ω–∞ | 5 —Å–µ–∫—É–Ω–¥ | `AUTO_UNBAN_DELAY_MS` |

### –¢–∞–π–º–∞—É—Ç—ã —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ |
|----------|----------|-----------|
| –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç | 10 —Å–µ–∫—É–Ω–¥ | `MESSAGE_DELETE_SHORT_TIMEOUT_MS` |
| –î–ª–∏–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç | 30 —Å–µ–∫—É–Ω–¥ | `MESSAGE_DELETE_LONG_TIMEOUT_MS` |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ | 5 —Å–µ–∫—É–Ω–¥ | `USER_OPERATION_DELAY_MS` |

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```typescript
const USER_RESTRICTIONS = {
  RESTRICTED: {
    can_send_messages: false,
    can_send_audios: false,
    // ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –æ—Ç–∫–ª—é—á–µ–Ω—ã
  },
  UNRESTRICTED: {
    can_send_messages: true,
    can_change_info: false, // –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç
    can_pin_messages: false, // –º–µ–Ω—è—Ç—å –∏–Ω—Ñ–æ –≥—Ä—É–ø–ø—ã
    can_manage_topics: false, // –∏–ª–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ø–∏–∫–∞–º–∏
  }
}
```

## üö´ –ê–Ω—Ç–∏—Å–ø–∞–º —Å–∏—Å—Ç–µ–º–∞

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏

- **–ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π** –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–¢–∞–π–º–∞—É—Ç API**: 5 —Å–µ–∫—É–Ω–¥
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏**: –º–∞–∫—Å–∏–º—É–º 2
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏**: 1 —Å–µ–∫—É–Ω–¥–∞

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∞–Ω—Ç–∏—Å–ø–∞–º–∞

```typescript
export const ANTI_SPAM_CONFIG = {
  TIMEOUT_MS: 5_000, // 5 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
  MAX_RETRIES: 2, // 2 –ø–æ–ø—ã—Ç–∫–∏
  RETRY_DELAY_MS: 1_000, // 1 —Å–µ–∫—É–Ω–¥–∞ –∑–∞–¥–µ—Ä–∂–∫–∞
} as const
```

### TTL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

UserManager –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–∑–Ω—ã–µ TTL –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö:

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | TTL | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|-----|-----------|----------|
| –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π | 48 —á–∞—Å–æ–≤ | `COUNTER_TTL` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ | 7 –¥–Ω–µ–π | `META_TTL` | –ò–º–µ–Ω–∞, username, –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è |
| –°–ø–∞–º-–¥–∞–Ω–Ω—ã–µ | 24 —á–∞—Å–∞ | `SPAM_TTL` | –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –∞–Ω—Ç–∏—Å–ø–∞–º–∞ |

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –°—Ö–µ–º–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ß–∞—Ç—ã** (`chats`)
   - `id` - BIGINT (Telegram chat ID –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º)
   - `type` - VARCHAR(50) - —Ç–∏–ø —á–∞—Ç–∞
   - `active` - BOOLEAN DEFAULT true - –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∞—Ç—å —á–∞—Ç—ã

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–∞—Ç–æ–≤** (`chat_configs`)
   - `geminiApiKey` - VARCHAR(512) - –¥–ª–∏–Ω–Ω—ã–µ API –∫–ª—é—á–∏
   - `systemPrompt` - JSONB - –≥–∏–±–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
   - `aiEnabled` - BOOLEAN DEFAULT true

3. **–ê–¥–º–∏–Ω—ã –≥—Ä—É–ø–ø** (`group_admins`)
   - –°–æ—Å—Ç–∞–≤–Ω–æ–π PRIMARY KEY (groupId, userId)
   - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

### –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã - JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```typescript
interface SystemPromptData {
  "–æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞"?: string
  "—Ö–∞—Ä–∞–∫—Ç–µ—Ä"?: string
  "–ø–æ–ª"?: string
}
```

## ‚öôÔ∏è API –∫–ª—é—á–∏ - –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞

1. **–¢–æ–ª—å–∫–æ –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ** —Å –±–æ—Ç–æ–º
2. **–§–æ—Ä–º–∞—Ç**: `/addAltronKey @group_name API_KEY`
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è**:
   ```typescript
   if (apiKey.length > 50) {
     return "API –∫–ª—é—á —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π"
   }
   ```

   **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í –ë–î –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–æ 512 —Å–∏–º–≤–æ–ª–æ–≤ (`VARCHAR(512)`), –Ω–æ –∫–æ–º–∞–Ω–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ 50 –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞.
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º —Ü–µ–ª–µ–≤–æ–π –≥—Ä—É–ø–ø—ã

### –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤

- –ü–æ–∏—Å–∫ –ø–æ username –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ì—Ä—É–ø–ø–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ (`/register`)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ ChatRepository

## üå§Ô∏è Weather Service

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π):

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
- **–õ–æ–∫–∞—Ü–∏—è**: Nha Trang, Vietnam (12.27¬∞N, 109.20¬∞E)
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 30 —Å–µ–∫—É–Ω–¥ (`UPDATE_INTERVAL_MS`)
- **–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞**: +7 —á–∞—Å–æ–≤ (–•–æ—à–∏–º–∏–Ω)
- **–ß–∞—Å—ã –ø—Ä–æ–≥–Ω–æ–∑–∞**: [9, 13, 17, 21] - 4 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
- **–†–∞–∑–º–µ—Ä canvas**: 400√ó400 –ø–∏–∫—Å–µ–ª–µ–π
- **–®—Ä–∏—Ñ—Ç—ã**: 20-22px –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- **–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞**: –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç (#fff) –Ω–∞ —Ç–µ–º–Ω–æ–º —Ñ–æ–Ω–µ

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```env
WEATHER_LATITUDE=12.2741076
WEATHER_LONGITUDE=109.2006335
WEATHER_UPDATE_INTERVAL_MS=30000
WEATHER_TIMEZONE_OFFSET=7
WEATHER_FORECAST_HOURS=9,13,17,21
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–æ–æ–±—â–µ–Ω–∏–π

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –æ—á–µ—Ä–µ–¥–∏

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è** —Å–æ–æ–±—â–µ–Ω–∏—è
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞** —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ (max 10)
3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ** –≤ –æ—á–µ—Ä–µ–¥—å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
4. **–ó–∞–ø—É—Å–∫** typing –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞** –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ –æ—á–µ—Ä–µ–¥–∏
6. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è** –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ AI
7. **–û—Ç–ø—Ä–∞–≤–∫–∞** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ + –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ typing

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

- **–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (`CONTEXT_SAVE_INTERVAL_MS`)
- **TTL –≤ Redis**: 24 —á–∞—Å–∞ (`CONTEXT_TTL_SECONDS`)
- **–û–±—Ä–µ–∑–∫–∞** –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 500 —Å–æ–æ–±—â–µ–Ω–∏–π (`MAX_CONTEXT_MESSAGES`)
- **–û—á–∏—Å—Ç–∫–∞** —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

### –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–µ–π

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ |
|----------|----------|-----------|
| –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ | 200 –º—Å | `QUEUE_PROCESS_INTERVAL_MS` |
| –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ | 30 —Å–µ–∫—É–Ω–¥ | `CONTEXT_SAVE_INTERVAL_MS` |
| –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ø—á–∏ | 5 —Å–µ–∫—É–Ω–¥ | `CAPTCHA_CHECK_INTERVAL_MS` |

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∞–π–º–∞—É—Ç—ã –∏ retry

- **Gemini API**: 5 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
- **–ê–Ω—Ç–∏—Å–ø–∞–º API**: 5 —Å–µ–∫—É–Ω–¥ + 2 retry
- **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏**: –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### Graceful degradation

- –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–æ–≤

### Health checks –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å:

- –†–∞–∑–º–µ—Ä—ã –æ—á–µ—Ä–µ–¥–µ–π AI (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ >7 —Å–æ–æ–±—â–µ–Ω–∏–π)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤–Ω–µ—à–Ω–∏—Ö API
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (–∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –º–æ–≥—É—Ç —Ä–∞—Å—Ç–∏)
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–∞ (–º–Ω–æ–≥–æ –∑–∞–¥–µ—Ä–∂–µ–∫ = –ø—Ä–æ–±–ª–µ–º–∞)

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ AI  
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–∞–º-—Å–æ–æ–±—â–µ–Ω–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—à–µ–Ω–∏—è –∫–∞–ø—á–∏
- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π –ø–æ —á–∞—Ç–∞–º

---

## üîß –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
- **RedisService** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è UserManager
- **DatabaseService** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è ChatRepository
- **TelegramBotService** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –±–æ—Ç–∞

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
- **CaptchaService** - –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫–∞–ø—á–∏
- **AntiSpamService** - –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∞–Ω—Ç–∏—Å–ø–∞–º–∞  
- **WeatherService** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
- **ApiServerService** - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π

**–ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –±–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.**
